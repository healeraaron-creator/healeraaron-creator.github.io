<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#4f46e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="LifeLog++">
    <title>LifeLog++ ç”Ÿæ´»æ•´åˆåŠ©æ‰‹ (Offline)</title>
    
    <!-- 1. æ ¸å¿ƒå‡½å¼åº« (React + HTM) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/htm@3.1.1/dist/htm.umd.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. å·¥å…·åº« (PDF èˆ‡ æˆªåœ–) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Tailwind Dark Mode Config -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#0f172a',
                            card: '#1e293b',
                            text: '#f1f5f9',
                            muted: '#94a3b8'
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out forwards',
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            -webkit-tap-highlight-color: transparent; 
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", sans-serif; 
            overflow-x: hidden; 
            transition: background-color 0.3s, color 0.3s;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        
        /* æ‰‹æ©Ÿç‰ˆåº•éƒ¨é˜²é®æ“‹å„ªåŒ– */
        .main-content { 
            min-height: 100vh;
            min-height: 100dvh; 
            padding-bottom: calc(10rem + env(safe-area-inset-bottom)) !important; 
        }
        @media (min-width: 768px) { .main-content { padding-bottom: 2rem !important; } }
        
        .nav-active { background-color: #4f46e5 !important; color: white !important; box-shadow: 0 4px 15px -3px rgba(79, 70, 229, 0.4); }
        canvas { touch-action: none; cursor: crosshair; image-rendering: pixelated; }
        .input-standard { 
            width: 100%; padding: 12px 14px; border-radius: 12px; font-weight: 600; outline: none; border: 2px solid transparent; transition: all 0.2s; font-size: 15px;
            background-color: #f1f5f9; color: #334155;
        }
        .dark .input-standard { background-color: #334155; color: #f8fafc; }
        .input-standard:focus { border-color: #4f46e5; background-color: #fff; box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1); }
        .dark .input-standard:focus { background-color: #1e293b; }
        .msg-box { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); z-index: 999; padding: 10px 24px; border-radius: 99px; font-weight: bold; font-size: 13px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); animation: fadeIn 0.3s ease; backdrop-filter: blur(8px); }
        .btn-circle { width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s; cursor: pointer; border: 1.5px solid #e2e8f0; background: #fff; }
        .dark .btn-circle { background: #1e293b; border-color: #334155; color: #cbd5e1; }
        .btn-circle:hover { border-color: #4f46e5; color: #4f46e5; }
        .btn-circle:active { transform: scale(0.9); }
        .glass-panel { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.5); }
        .dark .glass-panel { background: rgba(30, 41, 59, 0.8); border: 1px solid rgba(255,255,255,0.05); }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-dark-bg dark:text-dark-text selection:bg-indigo-500 selection:text-white">
    <div id="root">
        <div style="height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #4f46e5;">
            <div style="font-size: 42px; font-weight: 900; letter-spacing: -2px; margin-bottom: 12px; animation: fadeIn 1s infinite alternate;">LifeLog++</div>
            <div style="font-weight: bold; background: #eef2ff; padding: 8px 20px; border-radius: 99px; font-size: 13px; color: #4338ca;">å–®æ©Ÿé›¢ç·šç‰ˆ å•Ÿå‹•ä¸­...</div>
        </div>
    </div>

    <!-- PDF æ¸²æŸ“æš«å­˜å€ (éš±è—) -->
    <div id="pdf-temp-container" style="position: fixed; top: -9999px; left: -9999px; width: 210mm; min-height: 297mm; background: white; color: black; z-index: -1;"></div>

    <script>
        const { useState, useEffect, useRef, useMemo, Fragment, memo } = React;
        const html = htm.bind(React.createElement);

        // --- 0. å·¥å…·å‡½æ•¸ ---
        const compressImage = (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 800;
                        const scaleSize = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scaleSize;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.8));
                    }
                }
            });
        };

        // --- 1. åœ–ç¤ºçµ„ä»¶ ---
        function Icon({ name, size = 20, className = "" }) {
            const icons = {
                'home': html`<${Fragment}><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></${Fragment}>`,
                'dashboard': html`<g><rect x="3" y="3" width="7" height="9"/><rect x="14" y="3" width="7" height="5"/><rect x="14" y="12" width="7" height="9"/><rect x="3" y="16" width="7" height="5"/></g>`,
                'calendar': html`<g><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></g>`,
                'todo': html`<g><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></g>`,
                'note': html`<g><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></g>`,
                'wallet': html`<g><path d="M20 12V8H6a2 2 0 0 1-2-2c0-1.1.9-2 2-2h12v4"/><path d="M4 6v12c0 1.1.9 2 2 2h14v-4"/><path d="M18 12a2 2 0 0 0-2 2c0 1.1.9 2 2 2h4v-4h-4z"/></g>`,
                'map': html`<g><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></g>`,
                'trash': html`<g><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></g>`,
                'edit': html`<g><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></g>`,
                'plus': html`<g><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></g>`,
                'x': html`<g><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></g>`,
                'camera': html`<g><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></g>`,
                'image': html`<g><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></g>`,
                'pen': html`<g><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/></g>`,
                'download': html`<g><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></g>`,
                'file-text': html`<g><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></g>`,
                'loader': html`<g><path d="M12 2v4"/><path d="M12 18v4"/><path d="M4.93 4.93l2.83 2.83"/><path d="M16.24 16.24l2.83 2.83"/></g>`,
                'check': html`<polyline points="20 6 9 17 4 12"/>`,
                'chevron-left': html`<polyline points="15 18 9 12 15 6"/>`,
                'chevron-right': html`<polyline points="9 18 15 12 9 6"/>`,
                'moon': html`<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>`,
                'sun': html`<g><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></g>`,
                'help': html`<${Fragment}><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></${Fragment}>`,
                'settings': html`<circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>`,
                'refresh': html`<polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>`,
                'upload': html`<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>`
            };
            return html`
                <svg xmlns="http://www.w3.org/2000/svg" width=${size} height=${size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className=${className}>
                    ${icons[name] || html`<circle cx="12" cy="12" r="10" />`}
                </svg>
            `;
        }

        // --- 3. è¦–è¦ºåŒ–åœ–è¡¨ ---
        const FinancialChart = ({ income, expense }) => {
            const total = income + expense;
            if (total === 0) return html`
                <div className="h-24 bg-slate-50 dark:bg-slate-800 rounded-2xl flex items-center justify-center text-slate-300 dark:text-slate-600 text-xs font-bold">å°šç„¡è²¡å‹™æ•¸æ“š</div>
            `;
            const incomePct = Math.round((income / total) * 100);
            const expensePct = Math.round((expense / total) * 100);
            return html`
                <div className="space-y-3">
                    <div className="flex justify-between text-xs font-bold tracking-wider">
                        <span className="text-emerald-500">æ”¶å…¥ ${incomePct}%</span>
                        <span className="text-rose-500">æ”¯å‡º ${expensePct}%</span>
                    </div>
                    <div className="h-4 w-full bg-slate-100 dark:bg-slate-700 rounded-full overflow-hidden flex shadow-inner">
                        <div style=${{ width: `${incomePct}%` }} className="h-full bg-emerald-500 transition-all duration-1000 ease-out"></div>
                        <div style=${{ width: `${expensePct}%` }} className="h-full bg-rose-500 transition-all duration-1000 ease-out"></div>
                    </div>
                    <div className="flex justify-between text-[10px] text-slate-400 dark:text-slate-500 font-mono">
                        <span>$${income.toLocaleString()}</span>
                        <span>$${expense.toLocaleString()}</span>
                    </div>
                </div>
            `;
        };

        // --- 4. åŸºç¤ UI ---
        function Modal({ isOpen, onClose, title, children, isSaving = false, size = 'md' }) {
            if (!isOpen) return null;
            const szClass = size === 'lg' ? 'max-w-3xl' : 'max-w-md';
            return html`
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
                    <div className=${`bg-white dark:bg-dark-card rounded-[2rem] shadow-2xl w-full ${szClass} overflow-hidden animate-fade-in max-h-[92vh] flex flex-col border border-white/20 dark:border-slate-700`}>
                        <div className="flex justify-between items-center p-5 border-b border-slate-100 dark:border-slate-700 sticky top-0 bg-white/90 dark:bg-dark-card/90 z-10 backdrop-blur-md">
                            <h3 className="text-xl font-black text-slate-800 dark:text-slate-100 tracking-tight">${title}</h3>
                            <button onClick=${onClose} className="text-slate-300 hover:text-rose-500 p-1 active:scale-75 transition-transform"><${Icon} name="x" size=${24}/></button>
                        </div>
                        <div className="p-6 overflow-y-auto custom-scrollbar relative flex-1 text-slate-600 dark:text-slate-300">
                            ${isSaving && html`<div className="absolute inset-0 bg-white/80 dark:bg-slate-900/80 flex flex-col items-center justify-center z-20"><${Icon} name="loader" size=${40} className="animate-spin text-indigo-600 mb-2" /><span className="font-bold text-indigo-600 text-xs uppercase animate-pulse">è™•ç†ä¸­...</span></div>`}
                            ${children}
                        </div>
                    </div>
                </div>
            `;
        }

        const DrawingPad = memo(({ onSave, onCancel }) => {
            const canvasRef = useRef(null);
            const containerRef = useRef(null);
            const ctxRef = useRef(null);
            const isDrawing = useRef(false);

            useEffect(() => {
                const timer = setTimeout(() => {
                    const cvs = canvasRef.current;
                    if (!cvs || !containerRef.current) return;
                    cvs.width = containerRef.current.offsetWidth || 350;
                    cvs.height = 380;
                    const ctx = cvs.getContext('2d', { desynchronized: true });
                    ctx.lineCap = 'round'; ctx.lineJoin = 'round'; ctx.strokeStyle = '#4f46e5'; ctx.lineWidth = 4;
                    ctx.fillStyle = '#ffffff'; ctx.fillRect(0, 0, cvs.width, cvs.height);
                    ctxRef.current = ctx;

                    const getXY = (e) => {
                        const r = cvs.getBoundingClientRect();
                        return { x: e.clientX - r.left, y: e.clientY - r.top };
                    };
                    const start = (e) => { e.target.setPointerCapture(e.pointerId); isDrawing.current = true; ctx.beginPath(); const p = getXY(e); ctx.moveTo(p.x, p.y); };
                    const move = (e) => { if (!isDrawing.current) return; const p = getXY(e); requestAnimationFrame(() => { ctx.lineTo(p.x, p.y); ctx.stroke(); }); };
                    const end = () => { isDrawing.current = false; };
                    cvs.addEventListener('pointerdown', start); cvs.addEventListener('pointermove', move); cvs.addEventListener('pointerup', end);
                    return () => {
                        cvs.removeEventListener('pointerdown', start); cvs.removeEventListener('pointermove', move); cvs.removeEventListener('pointerup', end);
                    };
                }, 150);
                return () => clearTimeout(timer);
            }, []);

            return html`
                <div className="space-y-4 animate-fade-in" ref=${containerRef}>
                    <div className="border-2 border-dashed border-indigo-100 dark:border-slate-600 rounded-3xl overflow-hidden bg-white shadow-inner">
                        <canvas ref=${canvasRef} style=${{ touchAction: 'none' }} />
                    </div>
                    <div className="flex justify-between items-center px-1">
                        <button onClick=${()=>{ctxRef.current.fillStyle='#ffffff'; ctxRef.current.fillRect(0,0,canvasRef.current.width,canvasRef.current.height);}} className="text-rose-500 font-bold text-xs bg-rose-50 dark:bg-rose-900/20 px-4 py-2 rounded-xl">æ¸…é™¤é‡å¯«</button>
                        <div className="space-x-3">
                            <button onClick=${onCancel} className="text-slate-400 font-bold text-xs px-4">å–æ¶ˆ</button>
                            <button onClick=${()=>onSave(canvasRef.current.toDataURL('image/jpeg', 0.8))} className="bg-indigo-600 text-white px-6 py-2 rounded-xl font-bold text-xs shadow-lg active:scale-95 transition-all">ç¢ºèªå­˜å…¥</button>
                        </div>
                    </div>
                </div>
            `;
        });

        // --- 5. ä¸»æ‡‰ç”¨ç¨‹å¼ ---
        function App() {
            // Local Storage Keys
            const KEYS = {
                CONFIG: 'lifelog_offline_config',
                NOTES: 'lifelog_data_notes',
                TRANS: 'lifelog_data_transactions',
                PLANS: 'lifelog_data_plans',
                TODOS: 'lifelog_data_todos',
                THEME: 'lifelog_theme'
            };

            // App Config State
            const [appConfig, setAppConfig] = useState(() => {
                try {
                    const saved = localStorage.getItem(KEYS.CONFIG);
                    return saved ? JSON.parse(saved) : { userName: '', systemName: 'LifeLog++', isSetup: false };
                } catch {
                    return { userName: '', systemName: 'LifeLog++', isSetup: false };
                }
            });

            const [setupForm, setSetupForm] = useState({ 
                userName: appConfig.userName, 
                systemName: appConfig.systemName 
            });

            const [activeTab, setActiveTab] = useState('dashboard');
            const [darkMode, setDarkMode] = useState(() => localStorage.getItem(KEYS.THEME) === 'dark');
            const [message, setMessage] = useState(null);
            
            // Data States (Loaded from Local Storage)
            const [notes, setNotes] = useState(() => JSON.parse(localStorage.getItem(KEYS.NOTES) || '[]'));
            const [transactions, setTransactions] = useState(() => JSON.parse(localStorage.getItem(KEYS.TRANS) || '[]'));
            const [plans, setPlans] = useState(() => JSON.parse(localStorage.getItem(KEYS.PLANS) || '[]'));
            const [todos, setTodos] = useState(() => JSON.parse(localStorage.getItem(KEYS.TODOS) || '[]'));
            
            const [currentDate, setCurrentDate] = useState(new Date());
            const [deleteTarget, setDeleteTarget] = useState(null);
            const [showNoteModal, setShowNoteModal] = useState(false);
            const [showTransModal, setShowTransModal] = useState(false);
            const [showPlanModal, setShowPlanModal] = useState(false);
            const [showTodoModal, setShowTodoModal] = useState(false);
            const [showHelpModal, setShowHelpModal] = useState(false);
            const [showSettingsModal, setShowSettingsModal] = useState(false);
            const [isSaving, setIsSaving] = useState(false);
            const [isDrawingMode, setIsDrawingMode] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [dayDetail, setDayDetail] = useState(null);

            const defaultTrans = { type: 'expense', amount: '', category: '', recipient: '', description: '', date: '', time: '' };
            const defaultNote = { title: '', content: '', date: '', time: '', tags: '', attachments: [] };
            const defaultPlan = { title: '', location: '', startDate: '', endDate: '', description: '' };
            const defaultTodo = { title: '', content: '', date: '', time: '' };
            const [transForm, setTransForm] = useState(defaultTrans);
            const [noteForm, setNoteForm] = useState(defaultNote);
            const [planForm, setPlanForm] = useState(defaultPlan);
            const [todoForm, setTodoForm] = useState(defaultTodo);

            const flashMsg = (txt, type = 'success') => { setMessage({ txt, type }); setTimeout(() => setMessage(null), 3000); };

            // Effects for Persistence
            useEffect(() => { localStorage.setItem(KEYS.CONFIG, JSON.stringify(appConfig)); document.title = appConfig.systemName; }, [appConfig]);
            useEffect(() => { localStorage.setItem(KEYS.NOTES, JSON.stringify(notes)); }, [notes]);
            useEffect(() => { localStorage.setItem(KEYS.TRANS, JSON.stringify(transactions)); }, [transactions]);
            useEffect(() => { localStorage.setItem(KEYS.PLANS, JSON.stringify(plans)); }, [plans]);
            useEffect(() => { localStorage.setItem(KEYS.TODOS, JSON.stringify(todos)); }, [todos]);

            useEffect(() => {
                if (darkMode) {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem(KEYS.THEME, 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem(KEYS.THEME, 'light');
                }
            }, [darkMode]);

            // Computations
            const calLogic = useMemo(() => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const firstDay = new Date(year, month, 1).getDay();
                const totalDays = new Date(year, month + 1, 0).getDate();
                return { year, month, firstDay, totalDays };
            }, [currentDate]);

            const historyOptions = useMemo(() => {
                const cats = Array.from(new Set([...["é£²é£Ÿ", "äº¤é€š", "å¨›æ¨‚", "è³¼ç‰©", "å±…å®¶", "è–ªè³‡", "å…¶å®ƒ"], ...transactions.map(t => t.category)])).filter(Boolean);
                const recs = Array.from(new Set([...["è‡ªå·±", "å®¶äºº", "å…¬å¸", "æœ‹å‹"], ...transactions.map(t => t.recipient)])).filter(Boolean);
                return { categories: cats, recipients: recs };
            }, [transactions]);

            const uniqueTags = useMemo(() => {
                const tagsSet = new Set(["ç”Ÿæ´»", "éˆæ„Ÿ", "é‡è¦", "å¾…è¾¦"]);
                notes.forEach(n => {
                    if (n.tags) {
                        n.tags.split(/[,ï¼Œ\s]+/).forEach(t => { if (t.trim()) tagsSet.add(t.trim()); });
                    }
                });
                return Array.from(tagsSet);
            }, [notes]);

            const stats = useMemo(() => {
                const ti = transactions.filter(t => t.type === 'income').reduce((a, c) => a + (Number(c.amount) || 0), 0);
                const te = transactions.filter(t => t.type === 'expense').reduce((a, c) => a + (Number(c.amount) || 0), 0);
                return { in: ti, ex: te, bal: ti - te };
            }, [transactions]);

            // Handlers
            const handleSetupComplete = () => {
                if (!setupForm.userName.trim()) return alert("è«‹è¼¸å…¥æ“ä½œè€…åç¨±");
                setAppConfig({ 
                    ...setupForm, 
                    systemName: setupForm.systemName.trim() || 'LifeLog++', 
                    isSetup: true 
                });
            };

            const toggleTodo = (todo) => {
                const newTodos = todos.map(t => t.id === todo.id ? { ...t, completed: !t.completed } : t);
                setTodos(newTodos);
                flashMsg(todo.completed ? "ä»»å‹™å·²é‡å•Ÿ" : "ä»»å‹™å·²å®Œæˆï¼");
            };

            const saveData = (col, data, setForm, defaultForm, setModal, msg) => {
                if(!data.title && !data.amount) return;
                setIsSaving(true);
                
                // Simulate delay slightly for UX
                setTimeout(() => {
                    const newItem = { ...data, id: data.id || Date.now().toString(), timestamp: Date.now() };
                    if (newItem.amount) newItem.amount = Number(newItem.amount);

                    let setList;
                    let currentList;

                    switch(col) {
                        case 'notes': currentList = notes; setList = setNotes; break;
                        case 'transactions': currentList = transactions; setList = setTransactions; break;
                        case 'plans': currentList = plans; setList = setPlans; break;
                        case 'todos': currentList = todos; setList = setTodos; break;
                    }

                    if (editingId) {
                        setList(currentList.map(item => item.id === editingId ? newItem : item));
                    } else {
                        setList([...currentList, newItem]);
                    }

                    setForm(defaultForm);
                    setModal(false);
                    setEditingId(null);
                    setIsSaving(false);
                    flashMsg(msg);
                }, 300);
            };

            const handleImageUpload = async (e) => {
                if (e.target.files[0]) {
                    flashMsg("æ­£åœ¨å£“ç¸®åœ–ç‰‡...");
                    const compressed = await compressImage(e.target.files[0]);
                    setNoteForm(p => ({ ...p, attachments: [...p.attachments, { url: compressed }] }));
                    flashMsg("åœ–ç‰‡å·²å„ªåŒ–è¼‰å…¥");
                }
            };

            const executeDelete = () => {
                if (!deleteTarget) return;
                
                let setList;
                let currentList;

                switch(deleteTarget.col) {
                    case 'notes': currentList = notes; setList = setNotes; break;
                    case 'transactions': currentList = transactions; setList = setTransactions; break;
                    case 'plans': currentList = plans; setList = setPlans; break;
                    case 'todos': currentList = todos; setList = setTodos; break;
                }

                setList(currentList.filter(item => item.id !== deleteTarget.id));
                setDeleteTarget(null);
                flashMsg("å·²ç§»é™¤é …ç›®");
            };

            // Data Backup & Restore
            const exportBackup = () => {
                const data = { notes, transactions, plans, todos, appConfig };
                const blob = new Blob([JSON.stringify(data, null, 2)], {type : 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `LifeLog_Backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                flashMsg("å‚™ä»½æª”æ¡ˆå·²ä¸‹è¼‰");
            };

            const importBackup = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (confirm("é€™å°‡è¦†è“‹æ‚¨ç›®å‰çš„è³‡æ–™ï¼Œç¢ºå®šè¦é‚„åŸå—ï¼Ÿ")) {
                            if(data.notes) setNotes(data.notes);
                            if(data.transactions) setTransactions(data.transactions);
                            if(data.plans) setPlans(data.plans);
                            if(data.todos) setTodos(data.todos);
                            if(data.appConfig) setAppConfig(data.appConfig);
                            flashMsg("è³‡æ–™é‚„åŸæˆåŠŸï¼", "success");
                            setTimeout(() => window.location.reload(), 1500);
                        }
                    } catch (err) {
                        flashMsg("å‚™ä»½æª”æ¡ˆæ ¼å¼éŒ¯èª¤", "error");
                    }
                };
                reader.readAsText(file);
            };

            // Standard Exports
            const downloadFile = (content, name, type) => {
                const a = document.createElement('a');
                a.href = URL.createObjectURL(new Blob(["\uFEFF"+content], {type: type+";charset=utf-8"}));
                a.download = name; a.click();
            };

            const exportFinanceCSV = () => {
                if (transactions.length === 0) return flashMsg("ç„¡è²¡å‹™è³‡æ–™å¯åŒ¯å‡º", "error");
                let csv = "æ—¥æœŸ,æ™‚é–“,é¡åˆ¥,å°è±¡,æè¿°,æ”¶å…¥,æ”¯å‡º\n";
                transactions.forEach(t => {
                    const income = t.type === 'income' ? t.amount : '';
                    const expense = t.type === 'expense' ? t.amount : '';
                    csv += `${t.date},${t.time || ''},${t.category},"${t.recipient || ''}","${t.description||''}",${income},${expense}\n`;
                });
                csv += `\n,,,ç¸½è¨ˆ,,${stats.in},${stats.ex}\n`;
                csv += `,,,æ·¨è³‡ç”¢çµé¤˜,,${stats.bal}\n`;
                downloadFile(csv, `${appConfig.systemName}_è²¡å‹™å ±è¡¨_${currentDate.toISOString().split('T')[0]}.csv`, 'text/csv');
                flashMsg("è²¡å‹™å ±è¡¨å·²åŒ¯å‡º");
            };

            const exportPlanDoc = () => {
                 if (plans.length === 0) return flashMsg("ç„¡è¡Œç¨‹è³‡æ–™å¯åŒ¯å‡º", "error");
                 let docText = `${appConfig.systemName} è¡Œç¨‹è¦åŠƒæ¸…å–®\n========================================\n\n`;
                 plans.forEach(p => {
                     docText += `ã€ä¸»é¡Œã€‘ï¼š${p.title}\nã€æœŸé–“ã€‘ï¼š${p.startDate} ~ ${p.endDate}\nã€ç›®çš„åœ°ã€‘ï¼š${p.location}\nã€è©³ç´°è¦åŠƒã€‘ï¼š\n${p.description || 'ç„¡'}\n----------------------------------------\n\n`;
                 });
                 downloadFile(docText, `${appConfig.systemName}_è¡Œç¨‹å½™æ•´_${currentDate.toISOString().split('T')[0]}.txt`, 'text/plain');
                 flashMsg("è¡Œç¨‹æ¸…å–®å·²åŒ¯å‡º");
            };

            const exportSinglePlan = (p) => {
                 let docText = `${appConfig.systemName} å–®ç­†è¡Œç¨‹è¦åŠƒ\n========================================\n\n`;
                 docText += `ã€ä¸»é¡Œã€‘ï¼š${p.title}\nã€æœŸé–“ã€‘ï¼š${p.startDate} ~ ${p.endDate}\nã€ç›®çš„åœ°ã€‘ï¼š${p.location}\nã€è©³ç´°è¦åŠƒã€‘ï¼š\n${p.description || 'ç„¡'}\n----------------------------------------\n\nGenerated by ${appConfig.systemName}`;
                 downloadFile(docText, `${p.title}_è¡Œç¨‹è¦åŠƒ.txt`, 'text/plain');
                 flashMsg("å–®ç­†è¡Œç¨‹å·²åŒ¯å‡º");
            };

            const exportNoteText = (n) => {
                const content = `${appConfig.systemName} è¨˜äº‹å‚™ä»½\næ—¥æœŸ: ${n.date} ${n.time}\næ¨™é¡Œ: ${n.title}\næ¨™ç±¤: ${n.tags||''}\n----------------\n${n.content}`;
                downloadFile(content, `${n.title}.txt`, 'text/plain');
            };

            const exportNotePDF = async (n) => {
                flashMsg("æ­£åœ¨è£½ä½œé«˜ç•«è³ª PDFï¼Œè«‹ç¨å€™...");
                const container = document.getElementById('pdf-temp-container');
                if (!container) return;

                let imgsHtml = '';
                if (n.attachments && n.attachments.length > 0) {
                    imgsHtml = `<div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 25px;">
                        ${n.attachments.map(a => `<img src="${a.url}" style="max-width: 150px; max-height: 150px; object-fit: cover; border-radius: 8px; border: 1px solid #eee;" />`).join('')}
                    </div>`;
                }

                container.innerHTML = `
                    <div style="font-family: 'Noto Sans TC', sans-serif; padding: 40px; background: white;">
                        <h1 style="font-size: 28px; font-weight: bold; margin-bottom: 10px; color: #2d3748;">${n.title}</h1>
                        <div style="font-size: 14px; color: #718096; margin-bottom: 25px; border-bottom: 2px solid #e2e8f0; padding-bottom: 15px;">
                            <span style="margin-right: 15px;">ğŸ“… ${n.date} ${n.time}</span>
                            <span>ğŸ·ï¸ ${n.tags || 'æœªåˆ†é¡'}</span>
                        </div>
                        ${imgsHtml}
                        <div style="font-size: 16px; line-height: 1.8; color: #1a202c; white-space: pre-wrap; word-break: break-all;">${n.content}</div>
                        <div style="margin-top: 50px; font-size: 12px; color: #a0aec0; text-align: center; border-top: 1px solid #f7fafc; padding-top: 20px;">
                            Generated by ${appConfig.systemName} v68
                        </div>
                    </div>
                `;

                try {
                    const canvas = await html2canvas(container, { scale: 2, useCORS: true, logging: false });
                    const imgData = canvas.toDataURL('image/jpeg', 0.95);
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    const imgProps = pdf.getImageProperties(imgData);
                    const imgHeight = (imgProps.height * pdfWidth) / imgProps.width;
                    pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, imgHeight);
                    pdf.save(`${n.title}.pdf`);
                    flashMsg("PDF ä¸‹è¼‰æˆåŠŸï¼");
                } catch (err) {
                    console.error(err);
                    flashMsg("PDF è£½ä½œå¤±æ•—ï¼Œè«‹é‡è©¦", "error");
                } finally {
                    container.innerHTML = '';
                }
            };

            const getLunarDate = (date) => {
                try { 
                    const parts = new Intl.DateTimeFormat('zh-TW-u-ca-chinese', { day: 'numeric', month: 'short' }).formatToParts(date);
                    const dPart = parts.find(p => p.type === 'day').value.replace('æ—¥', '');
                    const mPart = parts.find(p => p.type === 'month').value;
                    if (dPart === '1' || dPart === 'åˆä¸€') return mPart;
                    return dPart; 
                } catch (e) { return ''; }
            };

            const openModal = (type, data = null) => {
                const now = new Date();
                const dateStr = now.toISOString().split('T')[0];
                const timeStr = now.toTimeString().slice(0,5);
                setEditingId(data?.id || null);
                if (type === 'trans') { setTransForm(data || {...defaultTrans, date: dateStr, time: timeStr}); setShowTransModal(true); }
                if (type === 'note') { setNoteForm(data || {...defaultNote, date: dateStr, time: timeStr}); setShowNoteModal(true); }
                if (type === 'plan') { setPlanForm(data || {...defaultPlan, startDate: dateStr, endDate: dateStr}); setShowPlanModal(true); }
                if (type === 'todo') { setTodoForm(data || {...defaultTodo, date: dateStr, time: timeStr}); setShowTodoModal(true); }
            };

            if (!appConfig.isSetup) {
                return html`
                    <div className="min-h-screen flex items-center justify-center bg-slate-50 dark:bg-dark-bg text-slate-800 dark:text-dark-text p-6">
                        <div className="bg-white dark:bg-dark-card w-full max-w-md p-8 rounded-[2.5rem] shadow-2xl border dark:border-slate-700 animate-fade-in">
                            <div className="text-center mb-8">
                                <div className="w-20 h-20 bg-indigo-600 rounded-3xl flex items-center justify-center text-white font-black text-3xl shadow-lg mx-auto mb-4 italic">L</div>
                                <h1 className="text-3xl font-black mb-2">æ­¡è¿ä½¿ç”¨</h1>
                                <p className="text-slate-400 text-sm font-bold">è«‹è¨­å®šæ‚¨çš„å€‹äººåŒ–ç³»çµ±è³‡è¨Š (é›¢ç·šç‰ˆ)</p>
                            </div>
                            
                            <div className="space-y-5">
                                <div>
                                    <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2 ml-2">æ“ä½œè€…åç¨±</label>
                                    <input type="text" value=${setupForm.userName} onInput=${e => setSetupForm({...setupForm, userName: e.target.value})} className="input-standard text-center text-lg" placeholder="ä¾‹å¦‚: æ¢ç´¢è€…" />
                                </div>
                                
                                <div>
                                    <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2 ml-2">ç³»çµ±åç¨±</label>
                                    <input type="text" value=${setupForm.systemName} onInput=${e => setSetupForm({...setupForm, systemName: e.target.value})} className="input-standard text-center text-lg" placeholder="é è¨­: LifeLog++" />
                                </div>

                                <button onClick=${handleSetupComplete} className="w-full py-4 bg-indigo-600 text-white rounded-2xl font-black text-lg shadow-xl hover:bg-indigo-700 active:scale-95 transition-all mt-4">
                                    é–‹å§‹ä½¿ç”¨ <${Icon} name="check" size=${20} className="inline ml-1"/>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            return html`
                <div className="min-h-screen flex flex-col md:flex-row bg-slate-50 dark:bg-dark-bg text-slate-800 dark:text-dark-text transition-colors duration-300">
                    ${message && html`<div className=${`msg-box ${message.type==='success'?'bg-emerald-500':'bg-rose-500'} text-white`}>${message.txt}</div>`}

                    <!-- Desktop Sidebar -->
                    <div className="hidden md:flex w-72 border-r dark:border-slate-700 h-screen sticky top-0 flex-col bg-white dark:bg-dark-card transition-colors">
                        <div className="p-8 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white font-black shadow-lg shadow-indigo-500/30">L</div>
                                <span className="text-xl font-black tracking-tighter">${appConfig.systemName}</span>
                            </div>
                            <button onClick=${()=>setDarkMode(!darkMode)} className="btn-circle">${darkMode ? html`<${Icon} name="sun" size=${20}/>` : html`<${Icon} name="moon" size=${20}/>`}</button>
                        </div>
                        
                        <nav className="p-4 space-y-2">
                            ${['dashboard', 'calendar', 'todo', 'plan', 'note', 'accounting'].map(id => html`
                                <button key=${id} onClick=${()=>setActiveTab(id)} className=${`w-full flex items-center p-4 rounded-xl font-bold transition-all ${activeTab === id ? 'nav-active' : 'text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800'}`}>
                                    <${Icon} name=${id==='plan'?'map':id==='accounting'?'wallet':id} className="mr-3" />
                                    <span>${id==='todo'?'ä»»å‹™ç®¡ç†':id==='plan'?'è¡Œç¨‹è¦åŠƒ':id==='note'?'è¨˜äº‹ç­†è¨˜':id==='accounting'?'è²¡å‹™ç®¡ç†':id==='calendar'?'å…¨æ›†ç¸½è¦½':'å„€è¡¨æ¿'}</span>
                                </button>
                            `)}
                        </nav>
                        
                        <div className="px-6 pb-4 flex gap-2 mt-2">
                            <button onClick=${()=>setShowSettingsModal(true)} className="flex-1 py-3 bg-slate-100 dark:bg-slate-800 rounded-xl text-xs font-bold text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors flex items-center justify-center gap-2"><${Icon} name="settings" size=${16}/> è¨­å®š</button>
                            <button onClick=${()=>setShowHelpModal(true)} className="w-12 py-3 bg-slate-100 dark:bg-slate-800 rounded-xl text-xs font-bold text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors flex items-center justify-center"><${Icon} name="help" size=${16}/></button>
                        </div>
                        
                        <div className="flex-1"></div>
                    </div>

                    <!-- Mobile Nav -->
                    <div className="md:hidden fixed bottom-0 left-0 right-0 bg-white/90 dark:bg-dark-card/90 backdrop-blur-lg border-t border-slate-100 dark:border-slate-800 z-50 safe-area-bottom flex justify-around p-2">
                        ${['dashboard', 'calendar', 'todo', 'plan', 'note', 'accounting'].map(id => html`
                            <button key=${id} onClick=${()=>setActiveTab(id)} className=${`flex flex-col items-center flex-1 py-1 transition-all ${activeTab === id ? 'text-indigo-600 dark:text-indigo-400 scale-105' : 'text-slate-300 dark:text-slate-600'}`}>
                                <${Icon} name=${id==='plan'?'map':id==='accounting'?'wallet':id} size=${22} />
                                <span className="text-[9px] mt-1 font-bold">${id==='todo'?'ä»»å‹™':id==='plan'?'è¡Œç¨‹':id==='note'?'è¨˜äº‹':id==='accounting'?'è¨˜å¸³':id==='calendar'?'æ—¥æ›†':'é¦–é '}</span>
                            </button>
                        `)}
                    </div>

                    <!-- Main Content -->
                    <main className="flex-1 p-4 md:p-10 main-content custom-scrollbar">
                        <div className="max-w-5xl mx-auto space-y-8 animate-fade-in">
                            
                            <!-- Header Mobile -->
                            <div className="flex justify-between items-center md:hidden">
                                <div className="flex items-center gap-2">
                                    <div className="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-black text-sm">L</div>
                                    <span className="font-black text-lg">${appConfig.systemName}</span>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick=${()=>setDarkMode(!darkMode)} className="p-2 bg-white dark:bg-slate-800 rounded-full shadow-sm">${darkMode ? html`<${Icon} name="sun" size=${18}/>` : html`<${Icon} name="moon" size=${18}/>`}</button>
                                    <button onClick=${()=>setShowSettingsModal(true)} className="p-2 bg-white dark:bg-slate-800 rounded-full shadow-sm"><${Icon} name="settings" size=${18}/></button>
                                    <button onClick=${()=>setShowHelpModal(true)} className="p-2 bg-white dark:bg-slate-800 rounded-full shadow-sm"><${Icon} name="help" size=${18}/></button>
                                </div>
                            </div>

                            ${activeTab === 'dashboard' && html`
                                <div className="space-y-6">
                                    <div className="glass-panel p-8 rounded-[2.5rem] flex flex-col md:flex-row items-center gap-8 shadow-sm">
                                        <div className="flex-1 text-center md:text-left space-y-2">
                                            <h2 className="text-2xl md:text-4xl font-black">åˆå®‰ï¼Œ${appConfig.userName}</h2>
                                            <p className="text-slate-400 dark:text-slate-500 font-bold">${appConfig.systemName} é›¢ç·šç‰ˆæ¨¡å¼å·²å•Ÿç”¨ã€‚è³‡æ–™å„²å­˜æ–¼æœ¬æ©Ÿç€è¦½å™¨ã€‚</p>
                                        </div>
                                        <div className="bg-gradient-to-br from-indigo-600 to-indigo-800 p-8 rounded-[2rem] text-white shadow-xl w-full md:w-72 text-center">
                                            <p className="opacity-70 text-xs font-bold uppercase tracking-widest mb-1">æœ¬æœˆæ·¨è³‡ç”¢</p>
                                            <h2 className="text-3xl font-black tracking-tight">$${stats.bal.toLocaleString()}</h2>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                        <div className="bg-white dark:bg-dark-card p-6 rounded-[2rem] shadow-sm border border-slate-100 dark:border-slate-800">
                                            <h3 className="font-bold text-sm text-slate-400 uppercase mb-4 flex justify-between">å¾…è¾¦é€Ÿè¦½ <${Icon} name="todo" size=${16}/></h3>
                                            <div className="space-y-3">
                                                ${todos.slice(0,3).map(t=>html`
                                                    <div key=${t.id} onClick=${()=>toggleTodo(t)} className="flex items-center text-sm font-bold bg-slate-50 dark:bg-slate-800/50 p-3 rounded-xl border dark:border-slate-700 cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
                                                        <div className=${`w-5 h-5 rounded-full mr-3 border-2 flex items-center justify-center transition-all ${t.completed?'bg-indigo-500 border-indigo-500':'border-slate-300'}`}>
                                                            ${t.completed && html`<${Icon} name="check" size=${12} className="text-white"/>`}
                                                        </div>
                                                        <span className=${t.completed ? 'text-slate-400 line-through' : ''}>${t.title}</span>
                                                    </div>
                                                `)}
                                                ${todos.length===0 && html`<div className="text-center text-slate-300 text-sm py-4">ç„¡å¾…è¾¦äº‹é …</div>`}
                                            </div>
                                        </div>

                                        <div className="bg-white dark:bg-dark-card p-6 rounded-[2rem] shadow-sm border border-slate-100 dark:border-slate-800">
                                            <h3 className="font-bold text-sm text-slate-400 uppercase mb-4 flex justify-between">è¿‘æœŸè¡Œç¨‹ <${Icon} name="map" size=${16}/></h3>
                                            <div className="space-y-3">
                                                ${plans.slice(0,3).map(p=>html`
                                                    <div key=${p.id} className="bg-slate-50 dark:bg-slate-800/50 p-3 rounded-xl border dark:border-slate-700">
                                                        <div className="font-bold text-sm truncate text-indigo-600 dark:text-indigo-400">${p.title}</div>
                                                        <div className="flex justify-between items-center mt-1 text-[10px] text-slate-400 font-bold">
                                                            <span><${Icon} name="calendar" size=${10} className="inline mr-1"/>${p.startDate}</span>
                                                            <span className="truncate max-w-[50%]"><${Icon} name="map" size=${10} className="inline mr-1"/>${p.location}</span>
                                                        </div>
                                                    </div>
                                                `)}
                                                ${plans.length===0 && html`<div className="text-center text-slate-300 text-sm py-4">ç„¡è¡Œç¨‹è¦åŠƒ</div>`}
                                            </div>
                                        </div>

                                        <div className="bg-white dark:bg-dark-card p-6 rounded-[2rem] shadow-sm border border-slate-100 dark:border-slate-800">
                                            <h3 className="font-bold text-sm text-slate-400 uppercase mb-4 flex justify-between">æœ€è¿‘è¨˜äº‹ <${Icon} name="note" size=${16}/></h3>
                                            <div className="space-y-3">
                                                ${notes.slice(0,3).map(n=>html`
                                                    <div key=${n.id} className="flex gap-3 bg-slate-50 dark:bg-slate-800/50 p-3 rounded-xl border dark:border-slate-700">
                                                        <div className="w-12 h-12 rounded-lg bg-slate-200 dark:bg-slate-700 overflow-hidden flex-shrink-0">
                                                            ${n.attachments?.[0] ? html`<img src=${n.attachments[0].url} className="w-full h-full object-cover"/>` : html`<div className="w-full h-full flex items-center justify-center text-slate-400"><${Icon} name="note" size=${20}/></div>`}
                                                        </div>
                                                        <div className="flex-1 min-w-0">
                                                            <div className="font-bold truncate text-sm">${n.title}</div>
                                                            <div className="text-[10px] text-slate-400">${n.date}</div>
                                                        </div>
                                                    </div>
                                                `)}
                                                ${notes.length===0 && html`<div className="text-center text-slate-300 text-sm py-4">ç„¡è¨˜äº‹å…§å®¹</div>`}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `}

                            ${activeTab === 'calendar' && html`
                                <div className="bg-white dark:bg-dark-card p-4 md:p-8 rounded-[2rem] shadow-sm border dark:border-slate-800">
                                    <div className="flex justify-between items-center mb-6">
                                        <h2 className="text-xl font-black flex items-center gap-2"><${Icon} name="calendar" className="text-indigo-500"/> ${calLogic.year} / ${calLogic.month+1}</h2>
                                        <div className="flex gap-2">
                                            <button onClick=${()=>setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth()-1)))} className="btn-circle shadow-sm"><${Icon} name="chevron-left" /></button>
                                            <button onClick=${()=>setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth()+1)))} className="btn-circle shadow-sm"><${Icon} name="chevron-right" /></button>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-7 gap-1 md:gap-2">
                                        ${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(d=>html`<div key=${d} className="text-center text-xs text-slate-400 py-2">${d}</div>`)}
                                        ${Array(calLogic.firstDay).fill(null).map((_,i)=>html`<div key=${`e-${i}`} className="h-16 md:h-28 bg-slate-50/50 dark:bg-slate-800/30 rounded-xl"></div>`)}
                                        ${Array.from({length:calLogic.totalDays},(_,i)=>i+1).map(d=>{
                                            const ds = `${calLogic.year}-${String(calLogic.month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                                            const hasN = notes.some(n=>n.date===ds); 
                                            const hasT = transactions.some(t=>t.date===ds);
                                            const hasTodo = todos.some(t=>t.date===ds);
                                            const hasPlan = plans.some(p=>ds>=p.startDate&&ds<=p.endDate);
                                            const isToday = ds === new Date().toISOString().split('T')[0];
                                            const lunar = getLunarDate(new Date(ds)); 

                                            return html`
                                                <div key=${d} onClick=${()=>{
                                                    const ns = notes.filter(n=>n.date===ds); const ts = transactions.filter(t=>t.date===ds);
                                                    const ps = plans.filter(p=>ds>=p.startDate&&ds<=p.endDate); const tds = todos.filter(t=>t.date===ds);
                                                    setDayDetail({date:ds, notes:ns, transactions:ts, plans:ps, todos:tds});
                                                }} className=${`h-16 md:h-28 border dark:border-slate-700 rounded-xl p-1 md:p-2 cursor-pointer transition-all hover:border-indigo-400 flex flex-col items-center justify-between ${isToday?'bg-indigo-50 dark:bg-indigo-900/20 border-indigo-200':''}`}>
                                                    <div className="flex flex-col items-center">
                                                        <span className=${`text-sm font-bold ${isToday?'text-indigo-600 dark:text-indigo-400':''}`}>${d}</span>
                                                        <span className="text-[10px] text-slate-400 dark:text-slate-500 font-normal scale-90 -mt-0.5">${lunar}</span>
                                                    </div>
                                                    <div className="flex gap-1 mb-1 flex-wrap justify-center">
                                                        ${hasPlan && html`<div className="w-1.5 h-1.5 rounded-full bg-purple-400" title="è¡Œç¨‹"></div>`}
                                                        ${hasTodo && html`<div className="w-1.5 h-1.5 rounded-full bg-blue-400" title="ä»»å‹™"></div>`}
                                                        ${hasN && html`<div className="w-1.5 h-1.5 rounded-full bg-orange-400" title="è¨˜äº‹"></div>`}
                                                        ${hasT && html`<div className="w-1.5 h-1.5 rounded-full bg-emerald-400" title="æ”¶æ”¯"></div>`}
                                                    </div>
                                                </div>
                                            `
                                        })}
                                    </div>
                                </div>
                            `}

                            ${['todo','plan','note','accounting'].includes(activeTab) && html`
                                <div className="space-y-6">
                                    <div className="flex justify-between items-center">
                                        <h2 className="text-2xl font-black flex items-center gap-2">
                                            ${activeTab==='accounting' && html`<span className="flex items-center gap-2">æ”¶æ”¯ç®¡ç† <span className="text-sm bg-indigo-100 text-indigo-700 px-2 py-1 rounded-lg dark:bg-indigo-900 dark:text-indigo-300">ç¸½è³‡ç”¢ $${stats.bal.toLocaleString()}</span></span>`}
                                            ${activeTab==='note' && 'ç­†è¨˜ä¸­å¿ƒ'}
                                            ${activeTab==='plan' && 'è¡Œç¨‹è¦åŠƒ'}
                                            ${activeTab==='todo' && 'ä»»å‹™æ¸…å–®'}
                                        </h2>
                                        <div className="flex gap-2">
                                            ${activeTab==='accounting' && html`<button onClick=${exportFinanceCSV} className="hidden md:flex bg-white dark:bg-slate-700 text-slate-500 dark:text-slate-300 px-3 py-2 rounded-xl shadow-sm border dark:border-slate-600 active:scale-95 font-bold items-center gap-2 hover:text-indigo-600" title="åŒ¯å‡º CSV å ±è¡¨"><${Icon} name="download" size=${18}/> å ±è¡¨</button>`}
                                            ${activeTab==='plan' && html`<button onClick=${exportPlanDoc} className="hidden md:flex bg-white dark:bg-slate-700 text-slate-500 dark:text-slate-300 px-3 py-2 rounded-xl shadow-sm border dark:border-slate-600 active:scale-95 font-bold items-center gap-2 hover:text-indigo-600" title="åŒ¯å‡ºè¡Œç¨‹æ¸…å–®"><${Icon} name="file-text" size=${18}/> åŒ¯å‡º</button>`}
                                            <button onClick=${()=>openModal(activeTab==='accounting'?'trans':activeTab)} className="bg-indigo-600 text-white px-4 py-2 rounded-xl shadow-lg active:scale-95 font-bold flex items-center gap-2 hover:bg-indigo-700"><${Icon} name="plus" size=${18}/> æ–°å¢</button>
                                        </div>
                                    </div>
                                    
                                    ${activeTab === 'accounting' && html`
                                        <div className="bg-white dark:bg-dark-card p-6 rounded-[2rem] shadow-sm border dark:border-slate-800">
                                            <h3 className="text-xs font-bold text-slate-400 mb-4 uppercase">æœ¬æœˆæ”¶æ”¯çµæ§‹åˆ†æ</h3>
                                            <${FinancialChart} income=${stats.in} expense=${stats.ex} />
                                        </div>
                                    `}

                                    <div className="grid grid-cols-1 gap-4">
                                        ${(activeTab==='todo'?todos:activeTab==='plan'?plans:activeTab==='note'?notes:transactions).map(item=>html`
                                            <div key=${item.id} className="bg-white dark:bg-dark-card p-5 rounded-2xl shadow-sm border dark:border-slate-800 flex items-center gap-4 group hover:shadow-md transition-all">
                                                
                                                ${activeTab==='todo' && html`
                                                    <button onClick=${(e)=>{e.stopPropagation(); toggleTodo(item);}} className=${`w-6 h-6 rounded-full border-2 flex-shrink-0 flex items-center justify-center transition-all ${item.completed ? 'bg-indigo-500 border-indigo-500' : 'border-slate-300 hover:border-indigo-500'}`}>
                                                        ${item.completed && html`<${Icon} name="check" size=${14} className="text-white"/>`}
                                                    </button>
                                                `}

                                                ${activeTab==='note' && item.attachments?.[0] && html`<img src=${item.attachments[0].url} className="w-16 h-16 rounded-xl object-cover bg-slate-100"/>`}
                                                
                                                <div className="flex-1 min-w-0">
                                                    <div className="flex justify-between items-start">
                                                        <h4 className=${`font-bold text-lg truncate pr-2 ${activeTab==='todo' && item.completed ? 'text-slate-400 line-through' : ''}`}>${item.title || item.category}</h4>
                                                        ${activeTab==='accounting' && html`<span className=${`font-mono font-bold ${item.type==='income'?'text-emerald-500':'text-rose-500'}`}>${item.type==='income'?'+':'-'}$${item.amount}</span>`}
                                                    </div>
                                                    <p className="text-sm text-slate-400 truncate">${item.content || item.description || item.location}</p>
                                                    <div className="text-[10px] text-slate-300 dark:text-slate-600 mt-1 font-bold uppercase tracking-wider">${item.date || item.startDate} ${item.time}</div>
                                                </div>
                                                <div className="flex gap-2 opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity">
                                                    ${activeTab==='note' && html`
                                                        <button onClick=${()=>exportNoteText(item)} className="p-2 text-slate-300 hover:text-indigo-500" title="åŒ¯å‡º TXT"><${Icon} name="file-text"/></button>
                                                        <button onClick=${()=>exportNotePDF(item)} className="p-2 text-slate-300 hover:text-indigo-500" title="åŒ¯å‡º PDF (å«åœ–ç‰‡/ä¸­æ–‡)"><${Icon} name="download"/></button>
                                                    `}
                                                    ${activeTab==='plan' && html`
                                                        <button onClick=${()=>exportSinglePlan(item)} className="p-2 text-slate-300 hover:text-indigo-500" title="åŒ¯å‡ºæ­¤è¡Œç¨‹ (TXT)"><${Icon} name="download"/></button>
                                                    `}
                                                    <button onClick=${()=>openModal(activeTab==='accounting'?'trans':activeTab, item)} className="p-2 text-slate-300 hover:text-indigo-500"><${Icon} name="edit"/></button>
                                                    <button onClick=${()=>setDeleteTarget({col:activeTab==='accounting'?'transactions':activeTab+'s', id:item.id})} className="p-2 text-slate-300 hover:text-rose-500"><${Icon} name="trash"/></button>
                                                </div>
                                            </div>
                                        `)}
                                        ${((activeTab==='todo'?todos:activeTab==='plan'?plans:activeTab==='note'?notes:transactions).length === 0) && html`<div className="text-center py-12 text-slate-300 font-bold">ç›®å‰æ²’æœ‰è³‡æ–™</div>`}
                                    </div>
                                </div>
                            `}

                        </div>
                    </main>

                    <${Modal} isOpen=${!!deleteTarget} onClose=${()=>setDeleteTarget(null)} title="ç¢ºèªåˆªé™¤">
                        <div className="text-center space-y-6">
                            <p className="text-slate-500">ç¢ºå®šè¦æ°¸ä¹…ç§»é™¤æ­¤é …ç›®å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚</p>
                            <div className="flex gap-4">
                                <button onClick=${()=>setDeleteTarget(null)} className="flex-1 py-3 bg-slate-100 dark:bg-slate-700 rounded-xl font-bold">å–æ¶ˆ</button>
                                <button onClick=${executeDelete} className="flex-1 py-3 bg-rose-500 text-white rounded-xl font-bold shadow-lg shadow-rose-500/30">ç¢ºèªåˆªé™¤</button>
                            </div>
                        </div>
                    </${Modal}>

                    <${Modal} isOpen=${!!dayDetail} onClose=${()=>setDayDetail(null)} title=${`${dayDetail?.date} æ‘˜è¦`}>
                        <div className="space-y-4">
                            ${['plans','todos','notes','transactions'].map(key => dayDetail?.[key]?.length > 0 && html`
                                <div key=${key} className="space-y-2">
                                    <h4 className="text-xs font-bold text-slate-400 uppercase tracking-widest">${key==='plans'?'è¡Œç¨‹':key==='todos'?'ä»»å‹™':key==='notes'?'ç­†è¨˜':'æ”¶æ”¯'}</h4>
                                    ${dayDetail[key].map(d=>html`
                                        <div key=${d.id} onClick=${()=>{setDayDetail(null); openModal(key==='transactions'?'trans':key.slice(0,-1), d);}} className="p-3 bg-slate-50 dark:bg-slate-800 rounded-xl text-sm font-bold flex justify-between cursor-pointer hover:bg-indigo-50 dark:hover:bg-indigo-900/30">
                                            <span>${d.title||d.category}</span>
                                            ${d.amount && html`<span>$${d.amount}</span>`}
                                        </div>
                                    `)}
                                </div>
                            `)}
                            ${Object.values(dayDetail||{}).flat().length === 1 && html`<div className="text-center text-slate-300 py-4">æœ¬æ—¥ç„¡ç´€éŒ„</div>`}
                        </div>
                    </${Modal}>

                    <${Modal} isOpen=${showTransModal} onClose=${()=>{setShowTransModal(false); setEditingId(null);}} title=${editingId?'ç·¨è¼¯æ”¶æ”¯':'æ–°å¢æ”¶æ”¯'} isSaving=${isSaving}>
                        <div className="space-y-4">
                            <div className="flex bg-slate-100 dark:bg-slate-800 p-1 rounded-xl">
                                ${['expense','income'].map(t=>html`<button key=${t} onClick=${()=>setTransForm({...transForm, type:t})} className=${`flex-1 py-3 rounded-lg font-bold text-sm transition-all ${transForm.type===t?'bg-white dark:bg-slate-600 shadow-sm text-indigo-600 dark:text-white':'text-slate-400'}`}>${t==='expense'?'æ”¯å‡º':'æ”¶å…¥'}</button>`)}
                            </div>
                            <input type="number" value=${transForm.amount} onChange=${e=>setTransForm({...transForm, amount:e.target.value})} className="text-center w-full bg-transparent text-5xl font-black outline-none text-slate-800 dark:text-white placeholder-slate-200" placeholder="0" />
                            <div className="grid grid-cols-2 gap-3">
                                <input type="date" value=${transForm.date} onChange=${e=>setTransForm({...transForm, date:e.target.value})} className="input-standard" />
                                <input type="time" value=${transForm.time} onChange=${e=>setTransForm({...transForm, time:e.target.value})} className="input-standard" />
                            </div>
                            <div className="grid grid-cols-2 gap-3">
                                <div>
                                    <input list="list-categories" value=${transForm.category} onChange=${e=>setTransForm({...transForm, category:e.target.value})} className="input-standard" placeholder="é¡åˆ¥ (å¦‚: é£²é£Ÿ)" autocomplete="off" />
                                    <datalist id="list-categories">${historyOptions.categories.map((c,i)=>html`<option key=${i} value=${c}>${c}</option>`)}</datalist>
                                </div>
                                <div>
                                    <input list="list-recipients" value=${transForm.recipient} onChange=${e=>setTransForm({...transForm, recipient:e.target.value})} className="input-standard" placeholder="å°è±¡ (å¦‚: è‡ªå·±)" autocomplete="off" />
                                    <datalist id="list-recipients">${historyOptions.recipients.map((r,i)=>html`<option key=${i} value=${r}>${r}</option>`)}</datalist>
                                </div>
                            </div>
                            <input type="text" value=${transForm.description} onChange=${e=>setTransForm({...transForm, description:e.target.value})} className="input-standard" placeholder="å‚™è¨»èªªæ˜ (å¦‚: åˆé¤ä¾¿ç•¶)" />
                            <button onClick=${()=>saveData('transactions', transForm, setTransForm, defaultTrans, setShowTransModal, "è¨˜å¸³æˆåŠŸ")} className="w-full py-4 bg-emerald-500 text-white rounded-xl font-black shadow-lg shadow-emerald-500/30 mt-4 active:scale-95 transition-transform">å„²å­˜ç´€éŒ„</button>
                        </div>
                    </${Modal}>

                    <${Modal} isOpen=${showNoteModal} onClose=${()=>{setShowNoteModal(false); setEditingId(null); setIsDrawingMode(false);}} title=${isDrawingMode?'æ‰‹ç¹ªæ¿':(editingId?'ç·¨è¼¯ç­†è¨˜':'æ–°å¢ç­†è¨˜')} size="lg" isSaving=${isSaving}>
                        ${!isDrawingMode ? html`
                            <div className="space-y-4">
                                <input type="text" value=${noteForm.title} onChange=${e=>setNoteForm({...noteForm, title:e.target.value})} className="input-standard text-lg" placeholder="æ¨™é¡Œ..." />
                                <div className="flex gap-2">
                                    <label className="flex-1 bg-slate-100 dark:bg-slate-800 p-3 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:bg-indigo-50 dark:hover:bg-slate-700 transition-colors">
                                        <${Icon} name="camera" className="mb-1 text-slate-500"/>
                                        <span className="text-[10px] font-bold text-slate-500">æ‹ç…§</span>
                                        <input type="file" className="hidden" accept="image/*" capture="environment" onChange=${handleImageUpload}/>
                                    </label>
                                    <label className="flex-1 bg-slate-100 dark:bg-slate-800 p-3 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:bg-indigo-50 dark:hover:bg-slate-700 transition-colors">
                                        <${Icon} name="image" className="mb-1 text-slate-500"/>
                                        <span className="text-[10px] font-bold text-slate-500">ç›¸ç°¿</span>
                                        <input type="file" className="hidden" accept="image/*" onChange=${handleImageUpload}/>
                                    </label>
                                    <button onClick=${()=>setIsDrawingMode(true)} className="flex-1 bg-slate-100 dark:bg-slate-800 p-3 rounded-xl flex flex-col items-center justify-center hover:bg-indigo-50 dark:hover:bg-slate-700 transition-colors">
                                        <${Icon} name="pen" className="mb-1 text-slate-500"/>
                                        <span className="text-[10px] font-bold text-slate-500">æ‰‹ç¹ª</span>
                                    </button>
                                </div>
                                ${noteForm.attachments.length > 0 && html`
                                    <div className="flex gap-2 overflow-x-auto py-2">
                                        ${noteForm.attachments.map((a,i)=>html`
                                            <div key=${i} className="relative w-24 h-24 flex-shrink-0">
                                                <img src=${a.url} className="w-full h-full object-cover rounded-lg"/>
                                                <button onClick=${()=>setNoteForm(p=>({...p, attachments:p.attachments.filter((_,idx)=>idx!==i)}))} className="absolute -top-1 -right-1 bg-rose-500 text-white rounded-full p-0.5"><${Icon} name="x" size=${12}/></button>
                                            </div>
                                        `)}
                                    </div>
                                `}
                                <textarea rows="6" value=${noteForm.content} onChange=${e=>setNoteForm({...noteForm, content:e.target.value})} className="input-standard" placeholder="å¯«é»ä»€éº¼..." />
                                
                                <div>
                                    <input list="list-tags" type="text" value=${noteForm.tags} onChange=${e=>setNoteForm({...noteForm, tags:e.target.value})} className="input-standard" placeholder="æ¨™ç±¤åˆ†é¡ (å¦‚: ç¾é£Ÿ, æ—…éŠ)..." autocomplete="off"/>
                                    <datalist id="list-tags">${uniqueTags.map((t,i)=>html`<option key=${i} value=${t}>${t}</option>`)}</datalist>
                                </div>

                                <div className="grid grid-cols-2 gap-3">
                                    <input type="date" value=${noteForm.date} onChange=${e=>setNoteForm({...noteForm, date:e.target.value})} className="input-standard" />
                                    <input type="time" value=${noteForm.time} onChange=${e=>setNoteForm({...noteForm, time:e.target.value})} className="input-standard" />
                                </div>
                                <button onClick=${()=>saveData('notes', noteForm, setNoteForm, defaultNote, setShowNoteModal, "ç­†è¨˜å·²å„²å­˜")} className="w-full py-4 bg-indigo-600 text-white rounded-xl font-black shadow-lg shadow-indigo-600/30 active:scale-95 transition-transform">å„²å­˜ç­†è¨˜</button>
                            </div>
                        ` : html`
                            <${DrawingPad} onSave=${(img)=>{setNoteForm(p=>({...p, attachments:[...p.attachments, {url:img}]})); setIsDrawingMode(false);}} onCancel=${()=>setIsDrawingMode(false)} />
                        `}
                    </${Modal}>

                    <${Modal} isOpen=${showPlanModal} onClose=${()=>{setShowPlanModal(false); setEditingId(null);}} title="è¡Œç¨‹è¦åŠƒ" isSaving=${isSaving}>
                        <div className="space-y-4">
                            <input type="text" value=${planForm.title} onChange=${e=>setPlanForm({...planForm, title:e.target.value})} className="input-standard text-lg" placeholder="è¡Œç¨‹åç¨± (å¦‚: æ—¥æœ¬è¡Œ)" />
                            <div className="grid grid-cols-2 gap-3">
                                <input type="date" value=${planForm.startDate} onChange=${e=>setPlanForm({...planForm, startDate:e.target.value})} className="input-standard" />
                                <input type="date" value=${planForm.endDate} onChange=${e=>setPlanForm({...planForm, endDate:e.target.value})} className="input-standard" />
                            </div>
                            <input type="text" value=${planForm.location} onChange=${e=>setPlanForm({...planForm, location:e.target.value})} className="input-standard" placeholder="åœ°é»" />
                            <textarea rows="4" value=${planForm.description} onChange=${e=>setPlanForm({...planForm, description:e.target.value})} className="input-standard" placeholder="è©³ç´°è¦åŠƒ..." />
                            <button onClick=${()=>saveData('plans', planForm, setPlanForm, defaultPlan, setShowPlanModal, "è¡Œç¨‹å·²å„²å­˜")} className="w-full py-4 bg-orange-500 text-white rounded-xl font-black shadow-lg shadow-orange-500/30 active:scale-95 transition-transform">å„²å­˜è¡Œç¨‹</button>
                        </div>
                    </${Modal}>

                    <${Modal} isOpen=${showTodoModal} onClose=${()=>{setShowTodoModal(false); setEditingId(null);}} title="å¾…è¾¦äº‹é …" isSaving=${isSaving}>
                        <div className="space-y-4">
                            <input type="text" value=${todoForm.title} onChange=${e=>setTodoForm({...todoForm, title:e.target.value})} className="input-standard text-lg" placeholder="è¦åšä»€éº¼ï¼Ÿ" />
                            <div className="grid grid-cols-2 gap-3">
                                <input type="date" value=${todoForm.date} onChange=${e=>setTodoForm({...todoForm, date:e.target.value})} className="input-standard" />
                                <input type="time" value=${todoForm.time} onChange=${e=>setTodoForm({...todoForm, time:e.target.value})} className="input-standard" />
                            </div>
                            <textarea rows="3" value=${todoForm.content} onChange=${e=>setTodoForm({...todoForm, content:e.target.value})} className="input-standard" placeholder="å‚™è¨»..." />
                            <button onClick=${()=>saveData('todos', todoForm, setTodoForm, defaultTodo, setShowTodoModal, "ä»»å‹™å·²å»ºç«‹")} className="w-full py-4 bg-indigo-600 text-white rounded-xl font-black shadow-lg shadow-indigo-600/30 active:scale-95 transition-transform">å»ºç«‹ä»»å‹™</button>
                        </div>
                    </${Modal}>

                    <${Modal} isOpen=${showHelpModal} onClose=${()=>setShowHelpModal(false)} title="ç³»çµ±æ“ä½œæŒ‡å—">
                        <div className="space-y-4 text-sm leading-relaxed">
                            <div className="p-5 bg-slate-50 dark:bg-slate-800/50 rounded-2xl space-y-6">
                                <section>
                                    <h4 className="font-black text-indigo-600 dark:text-indigo-400 mb-2 text-base flex items-center gap-2"><${Icon} name="refresh" size=${18}/> è³‡æ–™å‚™ä»½èˆ‡é‚„åŸ</h4>
                                    <p className="text-slate-600 dark:text-slate-400">æœ¬ç³»çµ±ç‚º<b>é›¢ç·šç‰ˆ</b>ï¼Œè³‡æ–™åƒ…å„²å­˜æ–¼ç€è¦½å™¨ä¸­ã€‚è«‹å®šæœŸè‡³ã€Œè¨­å®šã€é é¢åŸ·è¡Œ<b>ã€Œå‚™ä»½è³‡æ–™ (JSON)ã€</b>ï¼Œå°‡æª”æ¡ˆä¸‹è¼‰ä¿å­˜ã€‚è‹¥æ›´æ›è¨­å‚™æˆ–æ¸…é™¤å¿«å–ï¼Œå¯ä½¿ç”¨ã€Œé‚„åŸè³‡æ–™ã€åŠŸèƒ½åŒ¯å…¥å‚™ä»½æª”ã€‚</p>
                                </section>
                                
                                <section>
                                    <h4 className="font-black text-indigo-600 dark:text-indigo-400 mb-2 text-base flex items-center gap-2"><${Icon} name="calendar" size=${18}/> å…¨æ›†ç¸½è¦½</h4>
                                    <p className="text-slate-600 dark:text-slate-400">ä»¥æœˆæ›†å½¢å¼æª¢è¦–æ‰€æœ‰æ´»å‹•ã€‚æ—¥æœŸä¸‹æ–¹çš„åœ“é»ä»£è¡¨ç•¶æ—¥æœ‰ç´€éŒ„ï¼š<br/>
                                    <span className="inline-flex items-center gap-1 mt-1"><span className="w-2 h-2 rounded-full bg-purple-400"></span>è¡Œç¨‹</span>
                                    <span className="inline-flex items-center gap-1 mt-1 ml-2"><span className="w-2 h-2 rounded-full bg-blue-400"></span>ä»»å‹™</span>
                                    <span className="inline-flex items-center gap-1 mt-1 ml-2"><span className="w-2 h-2 rounded-full bg-orange-400"></span>è¨˜äº‹</span>
                                    <span className="inline-flex items-center gap-1 mt-1 ml-2"><span className="w-2 h-2 rounded-full bg-emerald-400"></span>æ”¶æ”¯</span><br/>
                                    é»æ“Šæ—¥æœŸæ ¼å³å¯æŸ¥çœ‹ç•¶æ—¥çš„è©³ç´°å…§å®¹æ‘˜è¦ã€‚</p>
                                </section>
                                
                                <section>
                                    <h4 className="font-black text-indigo-600 dark:text-indigo-400 mb-2 text-base flex items-center gap-2"><${Icon} name="wallet" size=${18}/> è²¡å‹™ç®¡ç†</h4>
                                    <p className="text-slate-600 dark:text-slate-400">å¿«é€Ÿè¨˜éŒ„æ”¶å…¥èˆ‡æ”¯å‡ºã€‚ç³»çµ±å…·å‚™<b>ã€Œæ™ºæ…§è¨˜æ†¶ã€</b>åŠŸèƒ½ï¼Œæœƒè‡ªå‹•è¨˜ä½æ‚¨è¼¸å…¥éçš„ã€Œé¡åˆ¥ã€èˆ‡ã€Œå°è±¡ã€ã€‚é»æ“Šå³ä¸Šè§’æŒ‰éˆ•å¯åŒ¯å‡º CSV å ±è¡¨ã€‚</p>
                                </section>

                                <section>
                                    <h4 className="font-black text-indigo-600 dark:text-indigo-400 mb-2 text-base flex items-center gap-2"><${Icon} name="note" size=${18}/> è¨˜äº‹ç­†è¨˜</h4>
                                    <p className="text-slate-600 dark:text-slate-400">æ”¯æ´å¤šå…ƒè¼¸å…¥æ–¹å¼ï¼š<b>æ–‡å­—æ’°å¯«</b>ã€<b>æ‹ç…§/ç›¸ç°¿åœ–ç‰‡åŒ¯å…¥</b>ä»¥åŠ<b>æ‰‹ç¹ªæ¿</b>åŠŸèƒ½ã€‚å–®ç¯‡ç­†è¨˜å¯åŒ¯å‡ºç‚ºç´”æ–‡å­— TXT æˆ–åŒ…å«åœ–ç‰‡æ’ç‰ˆçš„ PDF æª”æ¡ˆä»¥ä¾¿åˆ†äº«ã€‚</p>
                                </section>
                            </div>
                            <p className="text-slate-400 text-xs text-center pt-2">${appConfig.systemName} v69.0 (Offline) â€¢ æ‚¨çš„å…¨æ–¹ä½æ•¸ä½ç”Ÿæ´»ç®¡å®¶</p>
                        </div>
                    </${Modal}>

                    <${Modal} isOpen=${showSettingsModal} onClose=${()=>setShowSettingsModal(false)} title="ç³»çµ±è¨­å®š">
                        <div className="space-y-6">
                            
                            <div className="p-4 bg-indigo-50 dark:bg-indigo-900/30 rounded-2xl border border-indigo-100 dark:border-indigo-800 space-y-3">
                                <h4 className="text-xs font-black text-indigo-500 uppercase tracking-widest">è³‡æ–™ç®¡ç† (Backup & Restore)</h4>
                                <div className="grid grid-cols-2 gap-3">
                                    <button onClick=${exportBackup} className="flex flex-col items-center justify-center p-3 bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-indigo-100 dark:border-slate-700 hover:border-indigo-400 transition-colors">
                                        <${Icon} name="download" size=${24} className="text-indigo-500 mb-1"/>
                                        <span className="text-xs font-bold text-slate-600 dark:text-slate-300">å‚™ä»½è³‡æ–™ (JSON)</span>
                                    </button>
                                    <label className="flex flex-col items-center justify-center p-3 bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-indigo-100 dark:border-slate-700 hover:border-indigo-400 transition-colors cursor-pointer">
                                        <${Icon} name="upload" size=${24} className="text-emerald-500 mb-1"/>
                                        <span className="text-xs font-bold text-slate-600 dark:text-slate-300">é‚„åŸè³‡æ–™</span>
                                        <input type="file" accept=".json" onChange=${importBackup} className="hidden" />
                                    </label>
                                </div>
                                <p className="text-[10px] text-indigo-400 text-center">ğŸ’¡ å»ºè­°å®šæœŸå‚™ä»½ï¼Œä»¥é˜²ç€è¦½å™¨å¿«å–è¢«æ¸…é™¤ã€‚</p>
                            </div>

                            <div className="space-y-4">
                                <div>
                                    <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-1 ml-1">æ“ä½œè€…åç¨±</label>
                                    <input type="text" value=${appConfig.userName} onInput=${e => setAppConfig({...appConfig, userName: e.target.value})} className="input-standard" />
                                </div>
                                <div>
                                    <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-1 ml-1">ç³»çµ±åç¨±</label>
                                    <input type="text" value=${appConfig.systemName} onInput=${e => setAppConfig({...appConfig, systemName: e.target.value})} className="input-standard" />
                                </div>
                            </div>
                            
                            <div className="pt-4 border-t dark:border-slate-700">
                                <button onClick=${()=>setShowSettingsModal(false)} className="w-full py-4 bg-slate-800 dark:bg-slate-700 text-white rounded-xl font-bold shadow-lg active:scale-95 transition-all">å„²å­˜è¨­å®š</button>
                            </div>
                        </div>
                    </${Modal}>

                </div>
            `;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(html`<${App} />`);
    </script>
</body>
</html>